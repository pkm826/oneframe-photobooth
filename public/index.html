<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OneFrame - Photo Booth</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #ff4d6d 0%, #ff8cae 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .room-box {
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 50px;
      margin: 20px auto;
      backdrop-filter: blur(10px);
      display: inline-block;
      font-size: 1.2em;
      border: 2px solid white;
    }
    
    .status {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 50px;
      margin: 20px 0;
      font-weight: bold;
      font-size: 1.2em;
      backdrop-filter: blur(5px);
    }
    
    .videos {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .video-wrapper {
      position: relative;
      width: 300px;
      height: 400px;
      border-radius: 20px;
      overflow: hidden;
      border: 4px solid white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #1a1a1a;
    }
    
    .label {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(255,77,109,0.9);
      color: white;
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: bold;
      backdrop-filter: blur(5px);
      border: 2px solid white;
    }
    
    .button {
      background: white;
      color: #ff4d6d;
      border: none;
      padding: 15px 40px;
      font-size: 1.2em;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 2px solid white;
    }
    
    .button:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .photo-strip {
      background: white;
      padding: 30px;
      border-radius: 20px;
      margin-top: 30px;
      color: #333;
    }
    
    .strip-image {
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .debug-panel {
      background: rgba(0,0,0,0.9);
      color: #0f0;
      font-family: monospace;
      padding: 15px;
      border-radius: 10px;
      margin-top: 30px;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      border: 1px solid #0f0;
    }
    
    .debug-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      border: 1px solid white;
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .user-count {
      font-size: 1.1em;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üíò OneFrame</h1>
    
    <div class="room-box">
      üìç Room: <strong id="roomId">Loading...</strong>
    </div>
    
    <div class="status" id="status">
      üîµ Initializing...
    </div>
    
    <div class="user-count" id="userCount"></div>
    
    <div class="videos">
      <div class="video-wrapper">
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="label">üì± You</div>
      </div>
      <div class="video-wrapper">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="label">üíù Partner</div>
      </div>
    </div>
    
    <div>
      <button id="photoBtn" class="button" disabled>üì∏ TAKE PHOTO</button>
      <button id="resetBtn" class="button" style="display: none;">üîÑ NEW STRIP</button>
    </div>
    
    <div id="photoStrip" class="photo-strip" style="display: none;">
      <h3 style="color: #ff4d6d;">Your Photo Strip</h3>
      <div id="stripContainer"></div>
    </div>
    
    <div id="debugPanel" class="debug-panel" style="display: none;"></div>
    <button id="debugBtn" class="debug-button">üêõ Debug</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
      // Get room ID from URL
      const roomId = window.location.pathname.split('/room/')[1];
      document.getElementById('roomId').innerText = roomId;
      
      // DOM elements
      const status = document.getElementById('status');
      const userCountEl = document.getElementById('userCount');
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      const photoBtn = document.getElementById('photoBtn');
      const resetBtn = document.getElementById('resetBtn');
      const photoStrip = document.getElementById('photoStrip');
      const stripContainer = document.getElementById('stripContainer');
      const debugPanel = document.getElementById('debugPanel');
      const debugBtn = document.getElementById('debugBtn');
      
      // State
      let localStream = null;
      let peerConnection = null;
      let isConnected = false;
      let photos = [];
      let debugMode = false;
      let isInitiator = false;
      
      // ==================== DEBUG LOGGING ====================
      function log(...args) {
        const timestamp = new Date().toLocaleTimeString('en-US', { 
          hour12: false, 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit' 
        });
        const message = `[${timestamp}] ${args.join(' ')}`;
        console.log(message);
        
        if (debugMode) {
          debugPanel.innerHTML += message + '<br>';
          debugPanel.scrollTop = debugPanel.scrollHeight;
        }
      }
      
      // Toggle debug panel
      debugBtn.onclick = () => {
        debugMode = !debugMode;
        debugPanel.style.display = debugMode ? 'block' : 'none';
        debugBtn.innerText = debugMode ? 'üêõ Hide Debug' : 'üêõ Debug';
      };
      
      // ==================== SOCKET CONNECTION ====================
      log('üîå Connecting to server...');
      
      const socket = io(window.location.origin, {
        transports: ['polling', 'websocket'],
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 1000
      });
      
      socket.on('connect', () => {
        log('‚úÖ Connected to server with ID: ' + socket.id);
        socket.emit('join-room', roomId);
      });
      
      socket.on('role', (role) => {
        isInitiator = role === 'initiator';
        log(`üéÆ My role: ${role} (${isInitiator ? 'üì§ will send offer' : 'üì• will wait for offer'})`);
      });
      
      socket.on('user-count', (count) => {
        userCountEl.innerText = `üë• Users in room: ${count}/2`;
        log(`üë• Room users: ${count}/2`);
        
        if (count === 1) {
          status.innerText = 'üì± Waiting for partner to join...';
        } else if (count === 2) {
          status.innerText = 'üéØ Partner joined! Establishing connection...';
        }
      });
      
      socket.on('start-connection', ({ as }) => {
        log(`üöÄ Starting connection as: ${as}`);
        status.innerText = 'üîß Setting up video connection...';
        createPeerConnection(as === 'initiator');
      });
      
      socket.on('partner-left', () => {
        log('üëã Partner left the room');
        isConnected = false;
        status.innerText = 'üëã Partner left. Waiting for new partner...';
        photoBtn.disabled = true;
        remoteVideo.srcObject = null;
        
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
      });
      
      socket.on('signal', async ({ from, signal }) => {
        log(`üì° Received signal: ${signal.type}`);
        
        if (!peerConnection) {
          log('‚ö†Ô∏è No peer connection, creating one...');
          createPeerConnection(false);
        }
        
        try {
          if (signal.type === 'offer') {
            log('üìû Processing offer...');
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('signal', {
              roomId: roomId,
              signal: peerConnection.localDescription
            });
            log('üìû Answer sent');
          } 
          else if (signal.type === 'answer') {
            log('üìû Processing answer...');
            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal));
            log('‚úÖ Remote description set!');
          } 
          else if (signal.type === 'candidate' && signal.candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
            log('üßä ICE candidate added');
          }
        } catch (err) {
          log(`‚ùå Signal error: ${err.message}`);
        }
      });
      
      // ==================== CAMERA SETUP ====================
      try {
        status.innerText = 'üì∑ Requesting camera access...';
        log('üì∑ Requesting camera...');
        
        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          },
          audio: false
        });
        
        localVideo.srcObject = localStream;
        await localVideo.play();
        
        status.innerText = '‚úÖ Camera ready! Waiting for partner...';
        log('‚úÖ Camera initialized successfully');
      } catch (err) {
        status.innerText = '‚ùå Camera access denied! Please allow camera access.';
        log(`‚ùå Camera error: ${err.message}`);
        return;
      }
      
      // ==================== WEBRTC SETUP ====================
      function createPeerConnection(shouldCreateOffer = false) {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        
        log(`üîß Creating RTCPeerConnection (${shouldCreateOffer ? 'will create offer' : 'will wait for offer'})...`);
        
        // STUN + TURN servers for cross-network connections
        const configuration = {
          iceServers: [
            // ONLY USE THESE - THEY WORK!
            {
              urls: 'turn:turn.anyfirewall.com:443?transport=tcp',
              username: 'webrtc',
              credential: 'webrtc'
            },
            {
              urls: 'turn:turn2.anyfirewall.com:443?transport=tcp', 
              username: 'webrtc',
              credential: 'webrtc'
            }
          ],
          iceTransportPolicy: 'relay',  // üî¥ THIS IS THE MAGIC
          iceCandidatePoolSize: 10
        };
        
        peerConnection = new RTCPeerConnection(configuration);
        
        // Add local video tracks
        if (localStream) {
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
            log(`üé• Added local track: ${track.kind}`);
          });
        }
        
        // Handle incoming video
        peerConnection.ontrack = (event) => {
          log('‚úÖ ONTRACK: Received remote video stream!');
          
          if (event.streams && event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            remoteVideo.play()
              .then(() => {
                log('‚úÖ Remote video is playing!');
                isConnected = true;
                status.innerText = 'üíò Connected! Ready to take photos!';
                photoBtn.disabled = false;
              })
              .catch(e => log(`‚ö†Ô∏è Remote video play error: ${e.message}`));
          }
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            // Log candidate type
            if (event.candidate.candidate.includes('relay')) {
              log('üì° Sending TURN relay candidate');
            }
            
            socket.emit('signal', {
              roomId: roomId,
              signal: {
                type: 'candidate',
                candidate: event.candidate
              }
            });
          }
        };
        
        // Monitor connection state
        peerConnection.oniceconnectionstatechange = () => {
          const state = peerConnection.iceConnectionState;
          log(`üîÑ ICE state: ${state}`);
          
          if (state === 'connected' || state === 'completed') {
            isConnected = true;
            photoBtn.disabled = false;
            status.innerText = 'üíò Connected!';
          } else if (state === 'failed') {
            log('‚ùå ICE connection failed - trying to restart...');
            peerConnection.restartIce();
          } else if (state === 'disconnected') {
            log('‚ö†Ô∏è ICE disconnected');
          }
        };
        
        peerConnection.onicegatheringstatechange = () => {
          log(`üîÑ ICE gathering: ${peerConnection.iceGatheringState}`);
        };
        
        peerConnection.onconnectionstatechange = () => {
          log(`üîÑ Connection state: ${peerConnection.connectionState}`);
        };
        
        // Create offer if we're the initiator
        if (shouldCreateOffer) {
          setTimeout(async () => {
            try {
              log('üìû Creating offer...');
              const offer = await peerConnection.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: false
              });
              
              await peerConnection.setLocalDescription(offer);
              
              socket.emit('signal', {
                roomId: roomId,
                signal: peerConnection.localDescription
              });
              log('üìû Offer sent!');
            } catch (err) {
              log(`‚ùå Offer error: ${err.message}`);
            }
          }, 1000);
        } else {
          log('‚è≥ Waiting for offer...');
        }
      }
      
      // ==================== PHOTO CAPTURE ====================
      photoBtn.addEventListener('click', () => {
        if (!isConnected) {
          alert('Please wait for partner to connect!');
          return;
        }
        
        if (photos.length >= 4) {
          alert('Maximum 4 photos taken!');
          return;
        }
        
        // Create canvas
        const canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 800;
        const ctx = canvas.getContext('2d');
        
        // Draw both videos
        ctx.drawImage(localVideo, 0, 0, 300, 800);
        ctx.drawImage(remoteVideo, 300, 0, 300, 800);
        
        // Add frame
        ctx.strokeStyle = '#ff4d6d';
        ctx.lineWidth = 8;
        ctx.strokeRect(0, 0, canvas.width, canvas.height);
        
        // Add photo number
        ctx.fillStyle = '#ff4d6d';
        ctx.font = 'bold 30px Arial';
        ctx.fillText(`#${photos.length + 1}`, 20, 70);
        
        // Add date
        const date = new Date();
        ctx.font = '16px Arial';
        ctx.fillStyle = 'white';
        ctx.fillText(date.toLocaleDateString(), 20, 120);
        
        const photoData = canvas.toDataURL('image/jpeg', 0.9);
        photos.push(photoData);
        log(`üì∏ Photo ${photos.length} captured`);
        
        if (photos.length === 4) {
          generatePhotoStrip();
        }
      });
      
      function generatePhotoStrip() {
        // Hide videos, show strip
        document.querySelector('.videos').style.display = 'none';
        photoBtn.style.display = 'none';
        photoStrip.style.display = 'block';
        resetBtn.style.display = 'inline-block';
        
        // Create strip canvas
        const stripCanvas = document.createElement('canvas');
        stripCanvas.width = 300;
        stripCanvas.height = 400 * photos.length;
        const ctx = stripCanvas.getContext('2d');
        
        // White background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);
        
        // Add each photo
        let loaded = 0;
        photos.forEach((photo, index) => {
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, index * 400, 300, 400);
            loaded++;
            
            if (loaded === photos.length) {
              // Add vintage effect
              ctx.fillStyle = 'rgba(255, 77, 109, 0.05)';
              ctx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);
              
              // Add border
              ctx.strokeStyle = '#ff4d6d';
              ctx.lineWidth = 3;
              ctx.strokeRect(0, 0, stripCanvas.width, stripCanvas.height);
              
              // Display strip
              const stripImg = document.createElement('img');
              stripImg.src = stripCanvas.toDataURL('image/jpeg', 0.9);
              stripImg.className = 'strip-image';
              
              stripContainer.innerHTML = '';
              stripContainer.appendChild(stripImg);
              
              // Download button
              const downloadBtn = document.createElement('button');
              downloadBtn.innerText = 'üíæ Download Strip';
              downloadBtn.className = 'button';
              downloadBtn.style.marginTop = '20px';
              downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.download = `photobooth-${Date.now()}.jpg`;
                link.href = stripCanvas.toDataURL('image/jpeg', 0.9);
                link.click();
              };
              stripContainer.appendChild(downloadBtn);
            }
          };
          img.src = photo;
        });
      }
      
      resetBtn.addEventListener('click', () => {
        photos = [];
        document.querySelector('.videos').style.display = 'flex';
        photoBtn.style.display = 'inline-block';
        photoStrip.style.display = 'none';
        resetBtn.style.display = 'none';
        stripContainer.innerHTML = '';
        photoBtn.disabled = !isConnected;
      });
      
      // Cleanup
      window.addEventListener('beforeunload', () => {
        if (peerConnection) {
          peerConnection.close();
        }
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
        }
      });
    });
  </script>
</body>
</html>